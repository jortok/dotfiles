#!/bin/bash

# Script para encontrar, descargar y reproducir un video (.mp4 o .gif) desde una URL.
# Esta versi√≥n usa aria2c para descargas paralelas y m√°s r√°pidas.
# Tambi√©n remueve "-silent" de la URL si lo encuentra.
# Herramientas necesarias: curl, aria2c, mpv

# --- 1. Verificaci√≥n de Herramientas y Argumentos ---
# Se asegura de que aria2c est√© instalado.
if ! command -v aria2c &> /dev/null
then
    echo "¬°Error! La herramienta 'aria2c' no est√° instalada."
    echo "Por favor, inst√°lala para usar este script (ej: sudo apt install aria2)."
    exit 1
fi

# Se asegura de que el usuario haya proporcionado una URL como argumento.
if [ -z "$1" ]; then
  echo "¬°Error! Debes proporcionar una URL como argumento."
  echo "Uso: $0 <URL_DEL_SITIO_WEB>"
  exit 1
fi

URL_SITIO="$1"
echo "üîé Buscando un enlace de video en: $URL_SITIO"

# --- 2. Extracci√≥n de la URL del Video ---
# Usa curl para obtener el contenido HTML de la p√°gina.
# Usa grep con una expresi√≥n regular para encontrar la primera URL que termine en .mp4 o .gif.
VIDEO_URL=""
VIDEO_URL=$(curl -sL "$URL_SITIO" | grep -Eo '(http|https)://[^"]+\.(mp4|gif)' | head -n 1)
set +x
echo "URL: $VIDEO_URL"

# Verifica si se encontr√≥ una URL.
if [ -z "$VIDEO_URL" ]; then
  echo "‚ùå No se encontr√≥ ninguna URL de video (.mp4 o .gif o .m4s) en la p√°gina."
  exit 1
fi

echo "‚úÖ Video encontrado: $VIDEO_URL"

# --- 3. Modificaci√≥n de la URL (si es necesario) ---
# Si la URL contiene "-silent", lo quitamos para intentar obtener la versi√≥n con sonido.
# Se usa la sustituci√≥n de patrones de Bash: ${string//substring/replacement}
if [[ "$VIDEO_URL" == *"-silent"* ]]; then
  echo "üîá Detectado '-silent' en la URL. Modificando para obtener video con sonido."
  VIDEO_URL="${VIDEO_URL//-silent/}"
  echo "‚úÖ Nueva URL (sin '-silent'): $VIDEO_URL"
fi

# --- 4. Descarga del Video con aria2c ---
# Extrae el nombre del archivo de la URL para guardarlo en /tmp.
NOMBRE_ARCHIVO=$(basename "$VIDEO_URL")
RUTA_TEMPORAL="/tmp/$NOMBRE_ARCHIVO"

echo "üîΩ Descargando video con 4 conexiones paralelas en: $RUTA_TEMPORAL"
# Usa aria2c para una descarga m√°s r√°pida con m√∫ltiples conexiones.
# -q: modo silencioso.
# -x4: usa hasta 4 conexiones paralelas por servidor.
# -d: directorio de destino.
# -o: nombre del archivo de salida.
aria2c -q -x4 -d "/tmp" -o "$NOMBRE_ARCHIVO" "$VIDEO_URL"

# Verifica si la descarga fue exitosa.
if [ $? -ne 0 ]; then
    echo "‚ùå Error al descargar el archivo con aria2c."
    exit 1
fi

echo "üì• Descarga completada."

# --- 5. Reproducci√≥n del Video ---
echo "‚ñ∂Ô∏è  Reproduciendo video con mpv..."
mpv "$RUTA_TEMPORAL"

# --- 6. Limpieza (Opcional) ---
# Una vez cerrado mpv, el script continuar√° y borrar√° el archivo temporal.
echo "üóëÔ∏è  Limpiando archivo temporal..."
rm "$RUTA_TEMPORAL"

echo "‚ú® ¬°Listo!"
