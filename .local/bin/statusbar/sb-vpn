#!/bin/bash

VPN_NAME="jtokunaga"
ICON_ON="🟢"    # VPN Encendida
ICON_OFF="🔴"   # VPN Apagada

# Esta es la parte crucial para que los clics de dwmblocks funcionen:
# Se ejecuta cuando dwmblocks envía la variable BLOCK_BUTTON (al hacer clic)
if [ -n "$BLOCK_BUTTON" ] && [ "$BLOCK_BUTTON" -eq 1 ]; then
    VPN_STATUS_BEFORE_TOGGLE=$(nmcli con show --active | grep -q "$VPN_NAME" && echo "active")

    if [ "$VPN_STATUS_BEFORE_TOGGLE" == "active" ]; then
        # Intentar desactivar la VPN
        if nmcli con down "$VPN_NAME" >/dev/null 2>&1; then
            notify-send "VPN Desconectada" "La conexión '$VPN_NAME' se ha desactivado." -u normal -i network-offline
        else
            notify-send "Error de VPN" "No se pudo desactivar la conexión '$VPN_NAME'." -u critical -i network-error
        fi
    else
        # Intentar activar la VPN
        if nmcli con up "$VPN_NAME" >/dev/null 2>&1; then
            # 'nmcli con up' puede tomar un momento. Una notificación inmediata asume éxito.
            # Para mayor precisión, se podría verificar el estado después de un breve instante.
            notify-send "VPN Conectada" "La conexión '$VPN_NAME' se ha activado." -u normal -i network-vpn
        else
            notify-send "Error de VPN" "No se pudo activar la conexión '$VPN_NAME'." -u critical -i network-error
        fi
    fi
fi

# Esta parte SIEMPRE se ejecuta para mostrar el ícono en dwmblocks:
CURRENT_VPN_STATUS=$(nmcli con show --active | grep -q "$VPN_NAME" && echo "active")

if [ "$CURRENT_VPN_STATUS" == "active" ]; then
    echo "$ICON_ON"
else
    echo "$ICON_OFF"
fi
